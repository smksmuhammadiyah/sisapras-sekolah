generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  username          String             @unique
  password          String
  fullName          String?
  role              Role               @default(GUEST)
  isApproved        Boolean            @default(false)
  createdAt         DateTime           @default(now())
  email             String?            @unique
  isActive          Boolean            @default(true)
  jabatan           String?
  audits            Audit[]
  lendings          Lending[]
  procurements      Procurement[]
  reportedServices  Service[]          @relation("ServiceReporter")
  stockTransactions StockTransaction[]
}

model Room {
  id        String    @id @default(uuid())
  name      String
  type      String?
  location  String?
  deletedAt DateTime?
  assets    Asset[]
}

model Asset {
  id            String         @id @default(uuid())
  code          String         @unique
  name          String
  category      String
  spec          String?
  brand         String?
  origin        String?
  purchaseDate  DateTime
  purchaseYear  Int?
  price         Float?
  isWhiteListed Boolean?       @default(false)
  condition     AssetCondition @default(GOOD)
  roomId        String?
  managedById   String?
  deletedAt     DateTime?
  imageUrl      String?
  assetStatus   String?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  room          Room?          @relation(fields: [roomId], references: [id])
  auditItems    AuditItem[]
  lendings      Lending[]
  services      Service[]

  @@index([name])
  @@index([category])
  @@index([condition])
  @@index([origin])
  @@index([deletedAt])
  @@index([createdAt])
}

model Audit {
  id             String        @id @default(uuid())
  date           DateTime      @default(now())
  status         AuditStatus   @default(COMPLETED)
  auditorId      String
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  auditor        User          @relation(fields: [auditorId], references: [id])
  items          AuditItem[]
}

model AuditItem {
  id        String         @id @default(uuid())
  auditId   String
  assetId   String
  condition AssetCondition
  note      String?
  asset     Asset          @relation(fields: [assetId], references: [id])
  audit     Audit          @relation(fields: [auditId], references: [id])
}

model Service {
  id             String        @id @default(uuid())
  date           DateTime      @default(now())
  type           String
  cost           Float
  technician     String?
  notes          String?
  assetId        String
  reportedById   String?
  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id])
  asset          Asset         @relation(fields: [assetId], references: [id])
  reportedBy     User?         @relation("ServiceReporter", fields: [reportedById], references: [id])
}

model StockItem {
  id           String             @id @default(uuid())
  name         String
  unit         String
  spec         String?
  minStock     Int                @default(0)
  quantity     Int                @default(0)
  transactions StockTransaction[]
}

model StockTransaction {
  id             String               @id @default(uuid())
  date           DateTime             @default(now())
  type           StockTransactionType
  quantity       Int
  notes          String?
  stockItemId    String
  userId         String
  academicYearId String?
  academicYear   AcademicYear?        @relation(fields: [academicYearId], references: [id])
  stockItem      StockItem            @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  user           User                 @relation(fields: [userId], references: [id])
}

model Procurement {
  id              String              @id @default(uuid())
  title           String
  description     String?
  priority        ProcurementPriority
  totalBudget     Float
  status          ProcurementStatus   @default(PENDING)
  rejectionReason String?
  createdAt       DateTime            @default(now())
  requesterId     String
  academicYearId  String?
  deletedAt       DateTime?
  updatedAt       DateTime            @default(now()) @updatedAt
  academicYear    AcademicYear?       @relation(fields: [academicYearId], references: [id])
  requester       User                @relation(fields: [requesterId], references: [id])
  items           ProcurementItem[]
}

model ProcurementItem {
  id            String      @id @default(uuid())
  name          String
  spec          String?
  quantity      Int
  priceEst      Float
  totalEst      Float
  procurementId String
  procurement   Procurement @relation(fields: [procurementId], references: [id])
}

model SchoolSettings {
  id            String  @id @default(uuid())
  name          String  @default("SMK Negeri 1 Contoh")
  address       String  @default("Jl. Pendidikan No. 1")
  phone         String  @default("(021) 1234567")
  email         String  @default("info@smkn1contoh.sch.id")
  website       String?
  headmaster    String  @default("Drs. Kepala Sekolah, M.Pd")
  nipHeadmaster String  @default("19800101 200001 1 001")
  sarprasName   String  @default("Wakasek Sarpras, S.Pd")
  nipSarpras    String  @default("19850101 200501 1 001")
  logoLeft      String?
  logoRight     String?
}

model AcademicYear {
  id                String             @id @default(uuid())
  name              String
  isActive          Boolean            @default(false)
  startDate         DateTime
  endDate           DateTime
  audits            Audit[]
  procurements      Procurement[]
  services          Service[]
  stockTransactions StockTransaction[]
}

model Lending {
  id              String        @id @default(uuid())
  assetId         String
  borrowerId      String
  borrowerName    String
  borrowDate      DateTime      @default(now())
  returnDate      DateTime?
  conditionBefore String
  conditionAfter  String?
  notes           String?
  status          LendingStatus @default(BORROWED)
  asset           Asset         @relation(fields: [assetId], references: [id])
  borrower        User          @relation(fields: [borrowerId], references: [id])
}

model PasswordReset {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  STAFF
  USER
  GUEST
  KAPROG
  SISWA
}

enum AssetCondition {
  GOOD
  BROKEN_LIGHT
  BROKEN_HEAVY
}

enum StockTransactionType {
  IN
  OUT
}

enum ProcurementPriority {
  HIGH
  NORMAL
  LOW
}

enum ProcurementStatus {
  PENDING
  APPROVED
  REJECTED
  REVIEW_WAKASEK
}

model ReportSettings {
  id                String   @id @default(uuid())
  leftLogoUrl       String?
  rightLogoUrl      String?
  schoolName        String   @default("SMKS MUHAMMADIYAH SATUI")
  branchName        String   @default("MAJELIS PENDIDIKAN DASAR DAN MENENGAH")
  mainTitle         String   @default("PIMPINAN CABANG MUHAMMADIYAH SATUI")
  address           String   @default("Jl. KH. Ahmad Dahlan, No.07 Ds. Makmur Jaya, Kec. Satui, Kab. Tanah Bumbu (72275)")
  contactInfo       String   @default("NSPN : 69772942 NISS : 32215511 03 007 Telp: 081254721126/0852510455 - Email:smk.muhammadiyahsatui@gmail.com")
  principalName     String?
  vicePrincipalName String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("report_settings")
}

enum AuditStatus {
  DRAFT
  COMPLETED
}

enum LendingStatus {
  BORROWED
  RETURNED
}
